{% extends "mobile/base.html" %}

{% block title %}Statistics - Bible Clock Mobile{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Time Filter Tabs -->
    <div class="mobile-card bg-white p-4">
        <div class="flex flex-wrap gap-2">
            <button onclick="setTimeFilter('today')" id="today-tab" class="time-tab px-3 py-2 text-sm rounded-lg bg-blue-500 text-white" data-period="today">
                Today
            </button>
            <button onclick="setTimeFilter('week')" id="week-tab" class="time-tab px-3 py-2 text-sm rounded-lg bg-gray-200 text-gray-700" data-period="week">
                This Week
            </button>
            <button onclick="setTimeFilter('month')" id="month-tab" class="time-tab px-3 py-2 text-sm rounded-lg bg-gray-200 text-gray-700" data-period="month">
                This Month
            </button>
            <button onclick="setTimeFilter('year')" id="year-tab" class="time-tab px-3 py-2 text-sm rounded-lg bg-gray-200 text-gray-700" data-period="year">
                This Year
            </button>
            <button onclick="setTimeFilter('all')" id="all-tab" class="time-tab px-3 py-2 text-sm rounded-lg bg-gray-200 text-gray-700" data-period="all">
                All Time
            </button>
        </div>
    </div>
    
    <!-- Data/Chart Toggle -->
    <div class="mobile-card bg-white p-4">
        <div class="flex items-center justify-center space-x-2">
            <span class="text-sm text-gray-600 font-medium">View:</span>
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button onclick="setViewMode('data')" id="data-view-btn" class="view-btn px-3 py-2 text-sm rounded-md bg-white text-gray-700 shadow-sm" data-view="data">
                    ðŸ“Š Data
                </button>
                <button onclick="setViewMode('charts')" id="charts-view-btn" class="view-btn px-3 py-2 text-sm rounded-md text-gray-500" data-view="charts">
                    ðŸ“ˆ Charts
                </button>
            </div>
        </div>
    </div>
    <!-- Data View -->
    <div id="data-view" class="data-view">
    <!-- Today's Stats -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Today's Activity</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="text-center">
                <div class="text-3xl font-bold text-blue-600" id="verses-today" data-auto-refresh data-endpoint="/api/statistics" data-field="verses_today">--</div>
                <div class="text-sm text-gray-500">Verses Displayed</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-green-600" id="uptime-hours">--</div>
                <div class="text-sm text-gray-500">Time Online</div>
            </div>
        </div>
    </div>

    <!-- Display Mode Usage -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Display Mode Usage (Time)</h2>
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                    <span class="text-gray-700">Time Mode</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-lg font-semibold text-gray-800" id="time-mode-count">--</div>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" id="time-mode-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 bg-purple-500 rounded-full"></div>
                    <span class="text-gray-700">Devotional Mode</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-lg font-semibold text-gray-800" id="devotional-mode-count">--</div>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" id="devotional-mode-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                    <span class="text-gray-700">Bible Events Mode</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-lg font-semibold text-gray-800" id="date-mode-count">--</div>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" id="date-mode-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 bg-orange-500 rounded-full"></div>
                    <span class="text-gray-700">Random Mode</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-lg font-semibold text-gray-800" id="random-mode-count">--</div>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" id="random-mode-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 bg-cyan-500 rounded-full"></div>
                    <span class="text-gray-700">Weather Mode</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-lg font-semibold text-gray-800" id="weather-mode-count">--</div>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-cyan-500 h-2 rounded-full" id="weather-mode-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                    <span class="text-gray-700">News Mode</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-lg font-semibold text-gray-800" id="news-mode-count">--</div>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-red-500 h-2 rounded-full" id="news-mode-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 bg-indigo-500 rounded-full"></div>
                    <span class="text-gray-700">Parallel Mode</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-lg font-semibold text-gray-800" id="parallel-mode-count">--</div>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-500 h-2 rounded-full" id="parallel-mode-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Translation Usage -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Translation Usage</h2>
        <div id="translation-usage" class="space-y-3">
            <div class="text-gray-500 text-center py-4">Loading translation usage...</div>
        </div>
    </div>

    <!-- Translation Completion Status -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Local Translation Cache</h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600" id="cached-today">--</div>
                <div class="text-sm text-gray-500">Cached Today</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600" id="total-cached-verses">--</div>
                <div class="text-sm text-gray-500">Total Cached</div>
            </div>
        </div>
        <div id="translation-completion" class="space-y-3">
            <div class="text-gray-500 text-center py-4">Loading translation completion...</div>
        </div>
    </div>

    <!-- Books Accessed -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Bible Books Accessed</h2>
        <div class="text-center mb-4">
            <div class="text-4xl font-bold text-indigo-600" id="books-accessed-count">--</div>
            <div class="text-sm text-gray-500">Different Books Read</div>
        </div>
        <div id="books-accessed-list" class="space-y-2">
            <div class="text-gray-500 text-center py-4">Loading books data...</div>
        </div>
        <!-- Pagination Controls -->
        <div id="books-pagination" class="mt-4 flex justify-between items-center" style="display: none;">
            <div class="text-sm text-gray-500">
                <span id="books-page-info"></span>
            </div>
            <div class="flex space-x-2">
                <button id="books-prev-btn" onclick="changeBooksPage(-1)" 
                        class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                    Previous
                </button>
                <button id="books-next-btn" onclick="changeBooksPage(1)" 
                        class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- System Performance -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">System Performance</h2>
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-gray-700">CPU Usage</span>
                <div class="flex items-center space-x-2">
                    <span class="text-lg font-semibold" id="cpu-usage">--%</span>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" id="cpu-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <span class="text-gray-700">Memory Usage</span>
                <div class="flex items-center space-x-2">
                    <span class="text-lg font-semibold" id="memory-usage">--%</span>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-500 h-2 rounded-full" id="memory-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <span class="text-gray-700">CPU Temperature</span>
                <div class="flex items-center space-x-2">
                    <span class="text-lg font-semibold" id="cpu-temp">--Â°C</span>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-red-500 h-2 rounded-full" id="temp-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Recent Activity</h2>
        <div id="recent-activity" class="space-y-2">
            <div class="text-gray-500 text-center py-4">Loading recent activity...</div>
        </div>
    </div>

    <!-- Auto-refresh indicator -->
    <div class="mobile-card bg-blue-50 p-4">
        <div class="flex items-center space-x-3">
            <svg class="w-5 h-5 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <div>
                <div class="font-medium text-blue-800">Auto-Refresh Enabled</div>
                <div class="text-sm text-blue-700">Statistics update every 30 seconds</div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- Charts View -->
    <div id="charts-view" class="charts-view" style="display: none;">
        <div class="mobile-card bg-white p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Display Mode Usage Chart</h2>
            <div id="mode-chart" class="chart-container" style="height: 250px;">
                <div class="text-gray-500 text-center py-8">Chart will be generated from current data</div>
            </div>
        </div>
        
        <div class="mobile-card bg-white p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Translation Usage Chart</h2>
            <div id="translation-chart" class="chart-container" style="height: 250px;">
                <div class="text-gray-500 text-center py-8">Chart will be generated from current data</div>
            </div>
        </div>
        
        <div class="mobile-card bg-white p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Translation Completion Chart</h2>
            <div id="completion-chart" class="chart-container" style="height: 250px;">
                <div class="text-gray-500 text-center py-8">Chart will be generated from current data</div>
            </div>
        </div>
        
        <div class="mobile-card bg-white p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Bible Books Accessed Chart</h2>
            <div id="books-chart" class="chart-container" style="height: 250px;">
                <div class="text-gray-500 text-center py-8">Chart will be generated from current data</div>
            </div>
        </div>
        
        <div class="mobile-card bg-white p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">System Performance Chart</h2>
            <div id="performance-chart" class="chart-container" style="height: 250px;">
                <div class="text-gray-500 text-center py-8">Chart will be generated from current data</div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for pagination and filtering
let currentTimeFilter = 'today';
let currentViewMode = 'data';
let currentBooksPage = 1;
let booksPerPage = 10;
let totalBooksPages = 1;
let allBooksData = [];

function updateStatistics() {
    console.log('ðŸ“Š Updating mobile statistics at:', new Date().toLocaleTimeString());
    
    // Update filtered statistics using new API, fallback to basic API if needed
    fetch(`/api/statistics/filtered?filter=${currentTimeFilter}`)
        .then(response => {
            console.log('ðŸ“Š Filtered Statistics API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('ðŸ“Š Filtered Statistics data:', data);
            if (data.success) {
                const stats = data.data;
                
                // Update verses today with filtered data
                const versesToday = document.getElementById('verses-today');
                if (versesToday) {
                    const total = (stats.conversations && stats.conversations.total !== undefined) 
                        ? stats.conversations.total : 0;
                    versesToday.textContent = total;
                    console.log('âœ… Updated conversations:', total);
                }
                
                // Update mode usage with category data
                if (stats.conversations && stats.conversations.categories) {
                    updateModeUsage(stats.conversations.categories);
                }
                
                // Update translation usage
                if (stats.translation_usage) {
                    updateTranslationUsage(stats.translation_usage);
                }
                
                // Update books accessed with pagination
                if (stats.bible_books_accessed) {
                    updateBooksAccessedWithPagination(stats.bible_books_accessed);
                }
                
                // Update recent activity
                if (stats.recent_activities) {
                    updateRecentActivity(stats.recent_activities);
                }
                
                // If no data, try to fallback to basic statistics API
                if (stats.conversations && stats.conversations.total === 0) {
                    console.log('âš ï¸ No filtered data, falling back to basic statistics API');
                    updateBasicStatistics();
                }
            } else {
                console.error('Filtered statistics API failed, falling back to basic API');
                updateBasicStatistics();
            }
        })
        .catch(error => {
            console.error('Error fetching filtered statistics:', error);
            updateBasicStatistics();
        });
    
    // Update system status (unchanged)
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const status = data.data;
                
                // Update uptime from system status
                const uptimeHours = document.getElementById('uptime-hours');
                if (uptimeHours) {
                    if (status.uptime) {
                        const uptimeDate = new Date(status.uptime);
                        const now = new Date();
                        const hoursOnline = (now - uptimeDate) / (1000 * 60 * 60);
                        
                        if (hoursOnline >= 1) {
                            uptimeHours.textContent = hoursOnline.toFixed(1) + 'h';
                        } else {
                            const minutesOnline = Math.floor((now - uptimeDate) / (1000 * 60));
                            uptimeHours.textContent = minutesOnline + 'm';
                        }
                    } else {
                        // Fallback if no uptime data
                        uptimeHours.textContent = 'Active';
                    }
                }
                
                // Update system performance
                if (status.system) {
                    updateSystemPerformance(status.system);
                }
            }
        })
        .catch(console.error);
    
    // Load translation completion data
    loadTranslationCompletion();
}

function updateSystemPerformance(systemData) {
    if (!systemData) return;
    
    // Update CPU usage
    const cpuUsage = document.getElementById('cpu-usage');
    const cpuBar = document.getElementById('cpu-bar');
    if (cpuUsage && systemData) {
        const cpu = parseFloat(systemData.cpu_percent) || 0;
        cpuUsage.textContent = `${cpu.toFixed(1)}%`;
        if (cpuBar) cpuBar.style.width = `${Math.min(cpu, 100)}%`;
    }
    
    // Update memory usage
    const memoryUsage = document.getElementById('memory-usage');
    const memoryBar = document.getElementById('memory-bar');
    if (memoryUsage && systemData) {
        const memory = parseFloat(systemData.memory_percent) || 0;
        memoryUsage.textContent = `${memory.toFixed(1)}%`;
        if (memoryBar) memoryBar.style.width = `${Math.min(memory, 100)}%`;
    }
    
    // Update CPU temperature
    const cpuTemp = document.getElementById('cpu-temp');
    const tempBar = document.getElementById('temp-bar');
    if (cpuTemp && systemData && systemData.cpu_temperature !== null) {
        const temp = parseFloat(systemData.cpu_temperature) || 0;
        cpuTemp.textContent = `${temp.toFixed(1)}Â°C`;
        if (tempBar) tempBar.style.width = `${Math.min(temp / 80 * 100, 100)}%`; // Scale to 80Â°C max
    }
}

// Fetch translation completion data separately
function loadTranslationCompletion() {
    fetch('/api/translation-completion')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTranslationCompletion(data.data);
            }
        })
        .catch(console.error);
}

// Add fallback statistics function
function updateBasicStatistics() {
    console.log('ðŸ“Š Fallback: Updating basic statistics');
    
    // Fallback to basic statistics API
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            console.log('ðŸ“Š Basic Statistics data:', data);
            if (data.success) {
                const stats = data.data;
                
                // Update verses today
                const versesToday = document.getElementById('verses-today');
                if (versesToday && stats.verses_today !== undefined) {
                    versesToday.textContent = stats.verses_today;
                    console.log('âœ… Updated verses today (fallback):', stats.verses_today);
                }
                
                // Update mode usage
                if (stats.mode_usage) {
                    updateModeUsageBasic(stats.mode_usage);
                }
                
                // Update translation usage
                if (stats.translation_usage) {
                    updateTranslationUsage(stats.translation_usage);
                }
                
                // Update books accessed
                if (stats.books_accessed) {
                    updateBooksAccessedWithPagination(stats.books_accessed);
                }
                
                // Update recent activity
                if (stats.recent_activities) {
                    updateRecentActivity(stats.recent_activities);
                }
            }
        })
        .catch(console.error);
}

function updateModeUsageBasic(modeUsage) {
    const total = Object.values(modeUsage).reduce((sum, count) => sum + count, 0);
    
    if (total === 0) return;
    
    // Update individual mode counts and bars with basic API data
    ['time', 'devotional', 'date', 'random', 'weather', 'news', 'parallel'].forEach(mode => {
        const countElement = document.getElementById(`${mode}-mode-count`);
        const barElement = document.getElementById(`${mode}-mode-bar`);
        
        if (countElement && barElement) {
            const count = modeUsage[mode] || 0;
            const percentage = (count / total) * 100;
            
            // Convert count to hours (assuming each count represents a minute)
            const hours = count / 60;
            
            if (hours >= 1) {
                // Show hours with 1 decimal place if >= 1 hour
                countElement.textContent = hours.toFixed(1) + 'h';
            } else if (count > 0) {
                // Show minutes if less than 1 hour but greater than 0
                countElement.textContent = count + 'm';
            } else {
                // Show 0 for no usage
                countElement.textContent = '0';
            }
            
            barElement.style.width = `${percentage}%`;
        }
    });
}

function updateModeUsage(categoryData) {
    if (!categoryData) return;
    
    const total = Object.values(categoryData).reduce((sum, count) => sum + count, 0);
    if (total === 0) return;
    
    // Map API categories to display modes (adjust as needed)
    const modeMapping = {
        'bible_verse': 'devotional',
        'general': 'time', 
        'devotional': 'devotional',
        'time': 'time',
        'weather': 'weather',
        'news': 'news',
        'parallel': 'parallel',
        'random': 'random',
        'date': 'date'
    };
    
    // Initialize all mode counts to 0
    const modes = ['time', 'devotional', 'date', 'random', 'weather', 'news', 'parallel'];
    const modeCounts = {};
    modes.forEach(mode => modeCounts[mode] = 0);
    
    // Map API data to display modes
    Object.entries(categoryData).forEach(([category, count]) => {
        const mode = modeMapping[category];
        if (mode && modeCounts.hasOwnProperty(mode)) {
            modeCounts[mode] += count;
        }
    });
    
    // Update individual mode counts and bars
    modes.forEach(mode => {
        const countElement = document.getElementById(`${mode}-mode-count`);
        const barElement = document.getElementById(`${mode}-mode-bar`);
        
        if (countElement && barElement) {
            const count = modeCounts[mode] || 0;
            const percentage = total > 0 ? (count / total) * 100 : 0;
            
            // Display as conversation count (no time conversion for mobile)
            if (count > 0) {
                countElement.textContent = formatNumber(count);
            } else {
                countElement.textContent = '0';
            }
            
            barElement.style.width = `${percentage}%`;
        }
    });
}

function updateTranslationUsage(translationUsage) {
    const container = document.getElementById('translation-usage');
    if (!container) return;
    
    if (!translationUsage || Object.keys(translationUsage).length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">No translation usage data</div>';
        return;
    }
    
    const translations = Object.entries(translationUsage);
    const total = translations.reduce((sum, [, count]) => sum + count, 0);
    
    // Sort in descending order as requested
    const html = translations.sort((a, b) => b[1] - a[1]).map(([translation, count]) => {
        const percentage = total > 0 ? (count / total) * 100 : 0;
        return `
            <div class="flex items-center justify-between">
                <span class="text-gray-700">${translation.toUpperCase()}</span>
                <div class="flex items-center space-x-2">
                    <span class="text-lg font-semibold text-gray-800">${formatNumber(count)}</span>
                    <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function updateTranslationCompletion(completionData) {
    // Update daily cached verses
    const cachedTodayElement = document.getElementById('cached-today');
    if (cachedTodayElement && completionData.summary) {
        const cachedToday = completionData.summary.verses_cached_today || 0;
        cachedTodayElement.textContent = formatNumber(cachedToday);
    }
    
    // Update total cached verses
    const totalCachedElement = document.getElementById('total-cached-verses');
    if (totalCachedElement && completionData.translations) {
        const totalCached = Object.values(completionData.translations).reduce((sum, trans) => sum + (trans.cached_verses || 0), 0);
        totalCachedElement.textContent = formatNumber(totalCached);
    }
    
    // Update completion status for each translation
    const container = document.getElementById('translation-completion');
    if (!container || !completionData.translations) return;
    
    const translations = Object.entries(completionData.translations);
    if (translations.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">No translation data available</div>';
        return;
    }
    
    // Sort in descending order by completion percentage as requested
    const html = translations.sort((a, b) => b[1].completion_percentage - a[1].completion_percentage).map(([key, trans]) => {
        const percentage = trans.completion_percentage || 0;
        const isComplete = percentage > 99;
        const statusColor = isComplete ? 'text-green-600' : percentage > 50 ? 'text-orange-600' : 'text-gray-600';
        const barColor = isComplete ? 'bg-green-500' : percentage > 50 ? 'bg-orange-500' : 'bg-gray-400';
        
        return `
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="font-medium text-gray-800">${trans.display_name}</div>
                    <div class="text-sm text-gray-500">${formatNumber(trans.cached_verses || 0)} of ${formatNumber(trans.total_verses || 0)} verses</div>
                </div>
                <div class="flex items-center space-x-2 min-w-0 flex-shrink-0">
                    <span class="text-sm font-semibold ${statusColor}">${percentage.toFixed(1)}%</span>
                    <div class="w-16 bg-gray-200 rounded-full h-2">
                        <div class="${barColor} h-2 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function updateBooksAccessedWithPagination(booksAccessed) {
    if (!booksAccessed) return;
    
    // Convert to array if it's an object
    if (!Array.isArray(booksAccessed)) {
        if (typeof booksAccessed === 'object') {
            // Convert object to sorted array of entries, then extract book names
            allBooksData = Object.entries(booksAccessed)
                .sort((a, b) => b[1] - a[1]) // Sort by count descending
                .map(([book, count]) => ({ book, count }));
        } else {
            allBooksData = [];
        }
    } else {
        allBooksData = booksAccessed.map(book => ({ book, count: 1 }));
    }
    
    // Update total count
    const countElement = document.getElementById('books-accessed-count');
    if (countElement) {
        countElement.textContent = allBooksData.length;
    }
    
    // Calculate pagination
    totalBooksPages = Math.ceil(allBooksData.length / booksPerPage);
    currentBooksPage = Math.min(currentBooksPage, Math.max(1, totalBooksPages));
    
    displayBooksPage();
}

function displayBooksPage() {
    const listElement = document.getElementById('books-accessed-list');
    const paginationElement = document.getElementById('books-pagination');
    const pageInfoElement = document.getElementById('books-page-info');
    const prevBtn = document.getElementById('books-prev-btn');
    const nextBtn = document.getElementById('books-next-btn');
    
    if (!listElement) return;
    
    if (allBooksData.length === 0) {
        listElement.innerHTML = '<div class="text-gray-500 text-center py-4">No books accessed yet</div>';
        if (paginationElement) paginationElement.style.display = 'none';
        return;
    }
    
    // Calculate page data
    const startIndex = (currentBooksPage - 1) * booksPerPage;
    const endIndex = Math.min(startIndex + booksPerPage, allBooksData.length);
    const pageBooks = allBooksData.slice(startIndex, endIndex);
    
    // Generate HTML for current page
    const html = pageBooks.map(item => `
        <div class="bg-gray-50 p-2 rounded text-center text-sm">
            <div class="font-medium text-gray-700">${item.book}</div>
            ${item.count > 1 ? `<div class="text-xs text-gray-500">${item.count} verses</div>` : ''}
        </div>
    `).join('');
    
    listElement.innerHTML = `<div class="grid grid-cols-2 gap-2">${html}</div>`;
    
    // Update pagination controls
    if (totalBooksPages > 1 && paginationElement) {
        paginationElement.style.display = 'flex';
        
        if (pageInfoElement) {
            pageInfoElement.textContent = `Page ${currentBooksPage} of ${totalBooksPages}`;
        }
        
        if (prevBtn) {
            prevBtn.disabled = currentBooksPage <= 1;
            prevBtn.className = currentBooksPage <= 1 
                ? 'px-3 py-1 text-sm bg-gray-100 text-gray-400 rounded cursor-not-allowed'
                : 'px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
        }
        
        if (nextBtn) {
            nextBtn.disabled = currentBooksPage >= totalBooksPages;
            nextBtn.className = currentBooksPage >= totalBooksPages
                ? 'px-3 py-1 text-sm bg-gray-100 text-gray-400 rounded cursor-not-allowed'
                : 'px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600';
        }
    } else if (paginationElement) {
        paginationElement.style.display = 'none';
    }
}

function changeBooksPage(direction) {
    const newPage = currentBooksPage + direction;
    if (newPage >= 1 && newPage <= totalBooksPages) {
        currentBooksPage = newPage;
        displayBooksPage();
    }
}

// Keep the old function for backwards compatibility
function updateBooksAccessed(booksAccessed) {
    updateBooksAccessedWithPagination(booksAccessed);
}

function updateRecentActivity(activities) {
    const container = document.getElementById('recent-activity');
    if (!container) return;
    
    if (!Array.isArray(activities) || activities.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">No recent activity</div>';
        return;
    }
    
    // Show only the most recent 5 activities
    const recentActivities = activities.slice(0, 5);
    
    const html = recentActivities.map(activity => {
        const timestamp = new Date(activity.timestamp).toLocaleTimeString();
        return `
            <div class="bg-gray-50 p-3 rounded-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-medium text-gray-800">${activity.action}</div>
                        ${activity.details ? `<div class="text-sm text-gray-600">${activity.details}</div>` : ''}
                    </div>
                    <div class="text-xs text-gray-400">${timestamp}</div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

// Number formatting function
function formatNumber(num) {
    if (num === null || num === undefined || num === 0) return '0';
    return num.toLocaleString();
}

// Time filter functions (updated to work with filtered API)
function setTimeFilter(period) {
    currentTimeFilter = period;
    
    // Update tab visual states
    document.querySelectorAll('.time-tab').forEach(tab => {
        tab.classList.remove('bg-blue-500', 'text-white');
        tab.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    const activeTab = document.getElementById(`${period}-tab`);
    if (activeTab) {
        activeTab.classList.remove('bg-gray-200', 'text-gray-700');
        activeTab.classList.add('bg-blue-500', 'text-white');
    }
    
    // Reset pagination when filter changes
    currentBooksPage = 1;
    
    // Update statistics with new filter
    updateStatistics();
}

// View mode functions
function setViewMode(mode) {
    currentViewMode = mode;
    
    // Update button visual states
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('bg-white', 'text-gray-700', 'shadow-sm');
        btn.classList.add('text-gray-500');
    });
    
    const activeBtn = document.getElementById(`${mode}-view-btn`);
    if (activeBtn) {
        activeBtn.classList.remove('text-gray-500');
        activeBtn.classList.add('bg-white', 'text-gray-700', 'shadow-sm');
    }
    
    // Show/hide views
    const dataView = document.getElementById('data-view');
    const chartsView = document.getElementById('charts-view');
    
    if (mode === 'data') {
        if (dataView) dataView.style.display = 'block';
        if (chartsView) chartsView.style.display = 'none';
    } else {
        if (dataView) dataView.style.display = 'none';
        if (chartsView) chartsView.style.display = 'block';
        generateCharts();
    }
}

// Chart generation function (updated to use filtered data)
function generateCharts() {
    // Fetch chart data with current filter
    fetch(`/api/statistics/chart-data?filter=${currentTimeFilter}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                generateModeChart(data.data.mode_usage || {});
                generateTranslationChart(data.data.translation_usage || {});
                generateBooksChart(data.data.bible_books_accessed || {});
            }
        })
        .catch(console.error);
    
    generateCompletionChart();
    generatePerformanceChart();
}

function generateModeChart(modeData = {}) {
    const container = document.getElementById('mode-chart');
    if (!container) return;
    
    const modes = Object.entries(modeData);
    if (modes.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500">No mode usage data available</div>';
        return;
    }
    
    const total = modes.reduce((sum, [, count]) => sum + count, 0);
    const sortedModes = modes.sort((a, b) => b[1] - a[1]); // Descending order
    
    const colors = {
        'bible_verse': 'bg-blue-500',
        'general': 'bg-green-500', 
        'devotional': 'bg-purple-500',
        'time': 'bg-orange-500',
        'weather': 'bg-cyan-500',
        'news': 'bg-red-500'
    };
    
    const html = sortedModes.map(([mode, count]) => {
        const percentage = total > 0 ? (count / total) * 100 : 0;
        const colorClass = colors[mode] || 'bg-gray-500';
        return `
            <div class="flex justify-between items-center">
                <span>${mode.replace('_', ' ').toUpperCase()}</span>
                <div class="flex items-center space-x-2">
                    <span class="text-xs">${count}</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="${colorClass} h-4 rounded" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="p-4 text-center text-gray-500">
            <div class="mb-4">ðŸ“Š Mode Usage Distribution</div>
            <div class="space-y-2 text-sm">${html}</div>
        </div>
    `;
}

function generateTranslationChart(translationData = {}) {
    const container = document.getElementById('translation-chart');
    if (!container) return;
    
    const translations = Object.entries(translationData);
    if (translations.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500">No translation usage data available</div>';
        return;
    }
    
    const total = translations.reduce((sum, [, count]) => sum + count, 0);
    const sortedTranslations = translations.sort((a, b) => b[1] - a[1]); // Descending order
    
    const colors = ['bg-purple-500', 'bg-green-500', 'bg-yellow-500', 'bg-blue-500', 'bg-red-500', 'bg-indigo-500', 'bg-pink-500', 'bg-gray-500'];
    
    const html = sortedTranslations.slice(0, 8).map(([translation, count], index) => {
        const percentage = total > 0 ? (count / total) * 100 : 0;
        const colorClass = colors[index] || 'bg-gray-500';
        return `
            <div class="flex justify-between items-center">
                <span>${translation.toUpperCase()}</span>
                <div class="flex items-center space-x-2">
                    <span class="text-xs">${count}</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="${colorClass} h-4 rounded" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="p-4 text-center text-gray-500">
            <div class="mb-4">ðŸ“ˆ Translation Usage</div>
            <div class="space-y-2 text-sm">${html}</div>
        </div>
    `;
}

function generateCompletionChart() {
    const container = document.getElementById('completion-chart');
    if (!container) return;
    
    container.innerHTML = `
        <div class="p-4 text-center text-gray-500">
            <div class="mb-4">ðŸ“Š Cache Completion Status</div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between items-center">
                    <span>CEV</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="bg-green-500 h-4 rounded" style="width: 85%"></div>
                    </div>
                    <span class="text-xs">85%</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>AMP</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="bg-green-500 h-4 rounded" style="width: 82%"></div>
                    </div>
                    <span class="text-xs">82%</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>NLT</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="bg-orange-500 h-4 rounded" style="width: 15%"></div>
                    </div>
                    <span class="text-xs">15%</span>
                </div>
            </div>
        </div>
    `;
}

function generateBooksChart(booksData = {}) {
    const container = document.getElementById('books-chart');
    if (!container) return;
    
    const books = Object.entries(booksData);
    if (books.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500">No Bible books data available</div>';
        return;
    }
    
    const sortedBooks = books.sort((a, b) => b[1] - a[1]); // Descending order as requested
    const topBooks = sortedBooks.slice(0, 10);
    const maxCount = topBooks[0] ? topBooks[0][1] : 1;
    
    const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-yellow-500', 'bg-red-500', 'bg-indigo-500', 'bg-pink-500', 'bg-cyan-500', 'bg-orange-500', 'bg-gray-500'];
    
    const html = topBooks.map(([book, count], index) => {
        const percentage = (count / maxCount) * 100;
        const colorClass = colors[index] || 'bg-gray-500';
        return `
            <div class="flex justify-between items-center">
                <span>${book}</span>
                <div class="flex items-center space-x-2">
                    <span class="text-xs">${count}</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="${colorClass} h-4 rounded" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="p-4 text-center text-gray-500">
            <div class="mb-4">ðŸ“– Bible Books Accessed</div>
            <div class="space-y-2 text-sm">${html}</div>
        </div>
    `;
}

function generatePerformanceChart() {
    const container = document.getElementById('performance-chart');
    if (!container) return;
    
    container.innerHTML = `
        <div class="p-4 text-center text-gray-500">
            <div class="mb-4">âš¡ System Performance</div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between items-center">
                    <span>CPU Usage</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="bg-blue-500 h-4 rounded" style="width: 35%"></div>
                    </div>
                    <span class="text-xs">35%</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>Memory Usage</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="bg-yellow-500 h-4 rounded" style="width: 68%"></div>
                    </div>
                    <span class="text-xs">68%</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>CPU Temperature</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="bg-orange-500 h-4 rounded" style="width: 45%"></div>
                    </div>
                    <span class="text-xs">45Â°C</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>Disk Usage</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="bg-green-500 h-4 rounded" style="width: 22%"></div>
                    </div>
                    <span class="text-xs">22%</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>Network Activity</span>
                    <div class="w-24 bg-gray-200 rounded h-4">
                        <div class="bg-purple-500 h-4 rounded" style="width: 12%"></div>
                    </div>
                    <span class="text-xs">Low</span>
                </div>
            </div>
        </div>
    `;
}

// Initialize and set up auto-refresh
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Mobile statistics page loaded');
    
    // Set initial filter tab state
    setTimeFilter('today');
    
    // Auto-refresh every 30 seconds
    setInterval(updateStatistics, 30000);
});
</script>
{% endblock %}