{% extends "mobile/base.html" %}

{% block title %}Dashboard - Bible Clock Mobile{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Current Status Card -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">System Status</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600" id="system-health" data-auto-refresh data-endpoint="/api/status" data-field="system_health">Healthy</div>
                <div class="text-sm text-gray-500">System Health</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600" id="verses-today" data-auto-refresh data-endpoint="/api/status" data-field="verses_today">--</div>
                <div class="text-sm text-gray-500">Verses Today</div>
            </div>
        </div>
    </div>

    <!-- Current Mode Display -->
    <div class="mobile-card bg-gray-100 p-6">
        <h3 class="text-lg font-semibold mb-2 text-gray-700">Current Mode</h3>
        <div class="text-2xl font-bold text-blue-600" id="current-mode">Loading...</div>
    </div>

    <!-- Display Mode Controls -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Switch to Different Mode</h2>
        <div class="space-y-3" id="mode-buttons">
            <button id="time-mode-btn" onclick="setMode('time')" class="w-full mobile-button bg-blue-500 text-white py-4 px-6 rounded-lg touch-feedback hover:bg-blue-600 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-left">
                        <span class="text-lg block">Time Mode</span>
                        <span class="text-sm opacity-75">HH:MM = Chapter:Verse</span>
                    </div>
                </div>
            </button>
            
            <button id="devotional-mode-btn" onclick="setMode('devotional')" class="w-full mobile-button bg-purple-500 text-white py-4 px-6 rounded-lg touch-feedback hover:bg-purple-600 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <div class="text-left">
                        <span class="text-lg block">Devotional Mode</span>
                        <span class="text-sm opacity-75">Faith's Checkbook devotionals</span>
                    </div>
                </div>
            </button>
            
            <button id="date-mode-btn" onclick="setMode('date')" class="w-full mobile-button bg-green-500 text-white py-4 px-6 rounded-lg touch-feedback hover:bg-green-600 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <div class="text-left">
                        <span class="text-lg block">Bible Events Mode</span>
                        <span class="text-sm opacity-75">Biblical calendar events</span>
                    </div>
                </div>
            </button>
            
            <button id="random-mode-btn" onclick="setMode('random')" class="w-full mobile-button bg-orange-500 text-white py-4 px-6 rounded-lg touch-feedback hover:bg-orange-600 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h4a1 1 0 011 1v2m6 2a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6z"></path>
                    </svg>
                    <div class="text-left">
                        <span class="text-lg block">Random Mode</span>
                        <span class="text-sm opacity-75">Random Bible verses</span>
                    </div>
                </div>
            </button>
            
            <button id="weather-mode-btn" onclick="setMode('weather')" class="w-full mobile-button bg-sky-500 text-white py-4 px-6 rounded-lg touch-feedback hover:bg-sky-600 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                    </svg>
                    <div class="text-left">
                        <span class="text-lg block">Weather Mode</span>
                        <span class="text-sm opacity-75">Forecast with Moon Phase</span>
                    </div>
                </div>
            </button>
            
            <button id="news-mode-btn" onclick="setMode('news')" class="w-full mobile-button bg-purple-500 text-white py-4 px-6 rounded-lg touch-feedback hover:bg-purple-600 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                    </svg>
                    <div class="text-left">
                        <span class="text-lg block">Israel News</span>
                        <span class="text-sm opacity-75">Recent news from Israel</span>
                    </div>
                </div>
            </button>
            
            <button id="parallel-mode-btn" onclick="toggleParallelAndSetTime()" class="w-full mobile-button bg-teal-500 text-white py-4 px-6 rounded-lg touch-feedback hover:bg-teal-600 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10z"></path>
                    </svg>
                    <div class="text-left">
                        <span class="text-lg block">Parallel Mode</span>
                        <span class="text-sm opacity-75">Two translations side by side</span>
                    </div>
                </div>
            </button>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="mobile-card bg-white p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Quick Actions</h2>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="forceUpdate()" class="mobile-button bg-blue-500 text-white py-3 px-4 rounded-lg touch-feedback hover:bg-blue-600 flex flex-col items-center space-y-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span class="text-sm">Update Display</span>
            </button>
            
            <button onclick="clearGhosting()" class="mobile-button bg-red-500 text-white py-3 px-4 rounded-lg touch-feedback hover:bg-red-600 flex flex-col items-center space-y-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                <span class="text-sm">Clear Display</span>
            </button>
        </div>
    </div>


    <!-- Status Messages -->
    <div id="status-message" class="hidden mobile-card p-4 rounded-lg">
        <div id="status-text" class="font-medium"></div>
    </div>
</div>

<script>
// Mobile-optimized JavaScript functions
let manualUIUpdate = false; // Flag to prevent automatic updates from overriding manual changes
function setMode(mode) {
    showStatus(`Switching to ${mode} mode...`, 'info');
    
    // Immediately update UI optimistically
    document.getElementById('current-mode').textContent = 
        mode.charAt(0).toUpperCase() + mode.slice(1) + ' Mode';
    updateModeButtons(mode);
    
    // When switching to a regular mode, ensure parallel mode is disabled
    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            display_mode: mode, 
            parallel_mode: false,  // Explicitly disable parallel mode
            update_display: true 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(`Successfully switched to ${mode} mode`, 'success');
            
            // Update parallel mode toggle to reflect disabled state
            document.getElementById('parallel-mode-toggle').checked = false;
            
            // Confirm the change worked by updating from server
            updateCurrentMode();
            
            // Force a second refresh after a short delay to clear any artifacts
            setTimeout(() => {
                fetch('/api/refresh', { method: 'POST' })
                    .catch(console.error);
            }, 2000);
        } else {
            showStatus(`Failed to switch mode: ${data.error}`, 'error');
            // Revert optimistic UI update on failure
            updateCurrentMode();
        }
    })
    .catch(error => {
        showStatus(`Error: ${error.message}`, 'error');
        // Revert optimistic UI update on error
        updateCurrentMode();
    });
}

function forceUpdate() {
    showStatus('Updating display...', 'info');
    
    fetch('/api/refresh', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Display updated successfully', 'success');
        } else {
            showStatus(`Update failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showStatus(`Error: ${error.message}`, 'error');
    });
}

function clearGhosting() {
    showStatus('Clearing display ghosting...', 'info');
    
    fetch('/api/clear-ghosting', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Display cleared successfully', 'success');
        } else {
            showStatus(`Clear failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showStatus(`Error: ${error.message}`, 'error');
    });
}


function toggleParallelAndSetTime() {
    showStatus('Enabling parallel mode with time display...', 'info');
    
    // Enable parallel mode and set to time mode
    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            parallel_mode: true, 
            display_mode: 'time',
            update_display: true 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Parallel mode enabled', 'success');
            
            // Set flag to prevent automatic updates from interfering
            manualUIUpdate = true;
            
            // Update UI to reflect parallel mode
            document.getElementById('current-mode').textContent = 'Parallel Mode (Time)';
            
            // Update button visibility 
            updateModeButtons('time', true);
            
            // Force display refresh after delay
            setTimeout(() => {
                fetch('/api/refresh', { method: 'POST' })
                    .catch(console.error);
                
                // Reset flag after everything is done
                setTimeout(() => {
                    manualUIUpdate = false;
                    console.log('Manual UI update flag reset');
                }, 500);
            }, 1000);
        } else {
            showStatus(`Failed to enable parallel mode: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showStatus(`Error: ${error.message}`, 'error');
    });
}

function updateCurrentMode() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.display_mode) {
                const currentMode = data.data.display_mode;
                
                // Check if we need to get parallel mode status
                fetch('/api/settings')
                    .then(response => response.json())
                    .then(settingsData => {
                        const parallelMode = settingsData.success && settingsData.data.parallel_mode;
                        
                        // Update current mode display
                        if (parallelMode) {
                            document.getElementById('current-mode').textContent = 
                                `Parallel Mode (${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)})`;
                        } else {
                            document.getElementById('current-mode').textContent = 
                                currentMode.charAt(0).toUpperCase() + currentMode.slice(1) + ' Mode';
                        }
                        
                        // Update button visibility
                        updateModeButtons(currentMode, parallelMode);
                        
                    })
                    .catch(() => {
                        // Fallback if settings fetch fails
                        document.getElementById('current-mode').textContent = 
                            currentMode.charAt(0).toUpperCase() + currentMode.slice(1) + ' Mode';
                        updateModeButtons(currentMode, false);
                    });
            }
        })
        .catch(console.error);
}

function updateModeButtons(currentMode, parallelMode = false) {
    // Define all mode buttons including parallel
    const modeButtons = {
        'time': document.getElementById('time-mode-btn'),
        'devotional': document.getElementById('devotional-mode-btn'),
        'date': document.getElementById('date-mode-btn'),
        'random': document.getElementById('random-mode-btn'),
        'parallel': document.getElementById('parallel-mode-btn')
    };
    
    // Show all buttons first
    Object.values(modeButtons).forEach(button => {
        if (button) {
            button.style.display = 'flex';
        }
    });
    
    // Special logic for parallel mode
    if (parallelMode) {
        // If parallel mode is enabled, hide the parallel mode button but keep the base mode visible
        // so users can switch back to regular (non-parallel) mode
        if (modeButtons['parallel']) {
            modeButtons['parallel'].style.display = 'none';
        }
        // Don't hide the current base mode - users need a way to switch back to non-parallel
        // The current mode button will switch them back to regular mode without parallel
    } else {
        // If parallel mode is not enabled, just hide the current mode button
        if (modeButtons[currentMode]) {
            modeButtons[currentMode].style.display = 'none';
        }
    }
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('status-message');
    const statusText = document.getElementById('status-text');
    
    statusText.textContent = message;
    statusDiv.classList.remove('hidden', 'bg-blue-100', 'bg-green-100', 'bg-red-100', 'text-blue-800', 'text-green-800', 'text-red-800');
    
    if (type === 'success') {
        statusDiv.classList.add('bg-green-100', 'text-green-800');
    } else if (type === 'error') {
        statusDiv.classList.add('bg-red-100', 'text-red-800');
    } else {
        statusDiv.classList.add('bg-blue-100', 'text-blue-800');
    }
    
    statusDiv.classList.remove('hidden');
    
    setTimeout(() => {
        statusDiv.classList.add('hidden');
    }, 5000);
}

// Load initial state
document.addEventListener('DOMContentLoaded', function() {
    // Update current mode and button visibility
    updateCurrentMode();
    
    // Load current settings including parallel mode
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.data;
                
                
                // Update button visibility based on current mode and parallel mode
                if (settings.display_mode) {
                    updateModeButtons(settings.display_mode, settings.parallel_mode);
                }
            }
        })
        .catch(console.error);
});
</script>
{% endblock %}